<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>일정 등록</title>

<style>
  :root{
    --ea-card:#fff; --ea-line:#e5e7eb; --ea-text:#0f172a; --ea-muted:#6b7280;
    --ea-shadow:0 10px 24px rgba(0,0,0,.06); --ea-focus:#2563eb;
    --ea-badge:#eef2ff; --ea-badge-text:#374151;
  }
  *{box-sizing:border-box}
  body{margin:20px;background:#f6f7f9;color:var(--ea-text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
  a{color:inherit;text-decoration:none}

  .ea-wrap{max-width:1100px;margin:0 auto}
  .ea-title{margin:0 0 6px;font-size:22px;font-weight:800}
  .ea-sub{margin:0 0 18px;color:var(--ea-muted);font-size:13px}

  /* 카드 */
  .ea-card{background:var(--ea-card);border:1px solid var(--ea-line);border-radius:14px;
    box-shadow:var(--ea-shadow); padding:16px}

  /* 폼 그리드 */
  .ea-form{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .ea-form .row{display:flex;gap:8px;align-items:center}
  .ea-form label{min-width:72px;color:#334155;font-size:12px}
  .ea-form input[type="text"], .ea-form input[type="date"], .ea-form select{
    width:100%;border:1px solid var(--ea-line);border-radius:10px;padding:10px 12px;font-size:13px;background:#fff
  }
  .ea-form .full{grid-column:1/-1}
  .ea-actions{display:flex;gap:8px;align-items:center;margin-top:6px}

  /* 버튼 */
  .ea-btn{border:1px solid var(--ea-line);background:#fff;border-radius:10px;padding:9px 14px;
    font-size:13px;cursor:pointer;transition:box-shadow .15s, transform .05s}
  .ea-btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
  .ea-btn:hover{box-shadow:0 6px 16px rgba(0,0,0,.08)}
  .ea-btn:active{transform:translateY(1px)}
  .ea-btn[aria-pressed="true"]{box-shadow:inset 0 0 0 2px #2563eb33}

  /* 상단 툴바 */
  .ea-toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:14px 0 8px}
  .ea-toolbar .grow{flex:1}
  .ea-toolbar select,.ea-toolbar input[type="search"]{
    border:1px solid var(--ea-line);border-radius:10px;padding:8px 12px;font-size:13px;background:#fff
  }

  /* 테이블 */
  .ea-table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .ea-table thead th{font-size:12px;color:#64748b;text-align:left;padding:8px 10px}
  .ea-table tbody tr{background:#fff;border:1px solid var(--ea-line)}
  .ea-table tbody td{padding:12px 10px;font-size:13px;border-top:1px solid var(--ea-line)}
  .ea-table tbody tr{border-radius:12px;overflow:hidden}
  .ea-table tbody tr:hover{box-shadow:0 8px 18px rgba(0,0,0,.06)}
  .ea-td-actions{display:flex;gap:6px;justify-content:flex-end}

  /* 배지 */
  .badge{display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;
    background:var(--ea-badge); color:var(--ea-badge-text); font-size:12px; gap:6px}
  .badge.cat-행사{background:#f3e8ff;color:#6b21a8}
  .badge.cat-업무{background:#eff6ff;color:#1d4ed8}
  .badge.cat-신청{background:#ecfdf5;color:#047857}

  /* 모달 */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
  .modal .box{background:#fff;border:1px solid var(--ea-line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:16px;max-width:520px;width:100%}
  .modal .box h3{margin:0 0 10px;font-size:16px}
  .modal .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .modal .grid .full{grid-column:1/-1}
  .modal .grid label{display:block;font-size:12px;color:#334155;margin-bottom:4px}
  .modal .grid input,.modal .grid select{width:100%;border:1px solid var(--ea-line);border-radius:10px;padding:10px 12px;font-size:13px}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

  /* 토스트 */
  #ea-toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;opacity:.95;box-shadow:0 10px 24px rgba(0,0,0,.3);z-index:60;font-size:13px;display:none}

  @media (max-width:860px){ .ea-form{grid-template-columns:1fr} .modal .grid{grid-template-columns:1fr} }
</style>
</head>

<body>
<div class="ea-wrap">

  <!-- 상단 등록 카드 -->
  <div class="ea-card">
    <h1 class="ea-title">일정 등록</h1>
    <p class="ea-sub">캘린더에 표시할 일정을 추가/수정/삭제하세요.</p>

    <form id="event-form" class="ea-form" autocomplete="off">
      <div class="row">
        <label for="title">제목</label>
        <input id="title" name="title" type="text" placeholder="예: Leadership Day" required />
      </div>

      <div class="row">
        <label for="category">카테고리</label>
        <select id="category" name="category">
          <option>행사</option><option>업무</option><option>신청</option>
        </select>
      </div>

      <div class="row">
        <label for="start">시작일</label>
        <input id="start" name="start" type="date" required />
      </div>

      <div class="row">
        <label for="end">종료일</label>
        <input id="end" name="end" type="date" required />
      </div>

      <div class="row">
        <label for="lane">레인(팀)</label>
        <select id="lane" name="lane"></select>
      </div>

      <div class="row">
        <label for="note">메모</label>
        <input id="note" name="note" type="text" placeholder="비고(선택)" />
      </div>

      <div class="ea-actions full">
        <button class="ea-btn primary" type="submit">등록</button>
        <button class="ea-btn" type="reset">초기화</button>
        <a class="ea-btn" href="../" target="_blank" rel="noopener">게이트 열기</a>
      </div>
    </form>
  </div>

  <!-- 리스트 카드 -->
  <div class="ea-card" style="margin-top:14px">
    <div class="ea-toolbar">
      <input class="grow" id="search" type="search" placeholder="제목/팀/카테고리 검색" />
      <select id="sort">
        <option value="start desc">시작일 ▼</option>
        <option value="start asc">시작일 ▲</option>
        <option value="createdAt desc">최신 등록 ▼</option>
        <option value="createdAt asc">최신 등록 ▲</option>
      </select>
      <button id="refresh" class="ea-btn">새로고침</button>
    </div>

    <table class="ea-table">
      <thead>
        <tr>
          <th>제목</th>
          <th>기간</th>
          <th>팀</th>
          <th>카테고리</th>
          <th>메모</th>
          <th style="text-align:right">관리</th>
        </tr>
      </thead>
      <tbody id="list-body"></tbody>
    </table>
  </div>
</div>

<!-- 수정 모달 -->
<div id="edit-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="box">
    <h3>일정 수정</h3>
    <div class="grid">
      <div>
        <label for="e-title">제목</label>
        <input id="e-title" type="text" required />
      </div>
      <div>
        <label for="e-category">카테고리</label>
        <select id="e-category">
          <option>행사</option><option>업무</option><option>신청</option>
        </select>
      </div>
      <div>
        <label for="e-start">시작일</label>
        <input id="e-start" type="date" required />
      </div>
      <div>
        <label for="e-end">종료일</label>
        <input id="e-end" type="date" required />
      </div>
      <div>
        <label for="e-lane">레인(팀)</label>
        <select id="e-lane"></select>
      </div>
      <div class="full">
        <label for="e-note">메모</label>
        <input id="e-note" type="text" />
      </div>
    </div>
    <div class="actions">
      <button id="edit-cancel" class="ea-btn">취소</button>
      <button id="edit-save" class="ea-btn primary">저장</button>
    </div>
  </div>
</div>

<div id="ea-toast"></div>

<!-- Firebase + App 코드 -->
<script type="module">
  /* -------------------- 기본 상수/DOM -------------------- */
  const LANES = ["대표실","컴플","전략","재경","P&C","미션","교파","교미","비전","무브","디이","마캠","브컴","크리","특후","IT","SE","SR"];
  const laneSel = document.getElementById('lane');
  const laneEditSel = document.getElementById('e-lane');
  laneSel.innerHTML = LANES.map(v=>`<option>${v}</option>`).join('');
  laneEditSel.innerHTML = laneSel.innerHTML;

  const $ = (s)=>document.querySelector(s);
  function toast(msg){
    const t = $('#ea-toast');
    t.textContent = msg; t.style.display='block';
    clearTimeout(window._t); window._t = setTimeout(()=> t.style.display='none', 1800);
  }

  /* -------------------- Firebase 연결 -------------------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import {
    getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
    serverTimestamp, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBsTMadItNXG9YqmtFYr9bX6lbt0qIh9FQ",
    authDomain: "dcp-page.firebaseapp.com",
    projectId: "dcp-page",
    storageBucket: "dcp-page.firebasestorage.app",
    messagingSenderId: "1056273445903",
    appId: "1:1056273445903:web:9e924f9bd476a860af1f7a",
    measurementId: "G-CZS1G9M1KQ"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const col = collection(db, 'events');

  /* -------------------- 등록 -------------------- */
  $('#event-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const title = $('#title').value.trim();
    const category = $('#category').value;
    const start = $('#start').value;
    const end = $('#end').value || start;
    const lane = $('#lane').value;
    const note = $('#note').value.trim();

    if(!title || !start || !end || !lane){ toast('필수 항목을 확인하세요.'); return; }

    try{
      await addDoc(col, { title, category, start, end, lane, note, createdAt: serverTimestamp() });
      (e.target).reset();
      toast('등록되었습니다.');
    }catch(err){
      console.error(err); toast('등록에 실패했습니다.');
    }
  });

  /* -------------------- 실시간 목록/검색/정렬 -------------------- */
  let EVENTS = [];
  const tbody = $('#list-body');
  const $search = $('#search');
  const $sort = $('#sort');

  onSnapshot(col, (snap)=>{
    EVENTS = [];
    snap.forEach(d=>{
      const v = d.data();
      EVENTS.push({ id:d.id, ...v });
    });
    renderList();
  });

  $search.addEventListener('input', renderList);
  $sort.addEventListener('change', renderList);
  $('#refresh').addEventListener('click', ()=>{ renderList(); toast('새로고침'); });

  function renderList(){
    const q = $search.value.trim();
    const s = $sort.value; // "start desc" 등
    let rows = [...EVENTS];

    // 검색
    if(q){
      const qq = q.toLowerCase();
      rows = rows.filter(v=>
        (v.title||'').toLowerCase().includes(qq) ||
        (v.lane||'').toLowerCase().includes(qq) ||
        (v.category||'').toLowerCase().includes(qq)
      );
    }

    // 정렬
    const [key, dir] = s.split(' ');
    rows.sort((a,b)=>{
      const va = (a[key] || ''), vb = (b[key] || '');
      return dir==='asc' ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
    });

    // 렌더
    tbody.innerHTML = '';
    rows.forEach(v=>{
      const tr = document.createElement('tr');

      const tdTitle = document.createElement('td'); tdTitle.textContent = v.title||'';
      const tdPeriod= document.createElement('td'); tdPeriod.textContent= `${v.start||''} ~ ${v.end||''}`;
      const tdLane  = document.createElement('td'); tdLane.textContent  = v.lane||'';

      const tdCat   = document.createElement('td');
      const badge   = document.createElement('span');
      badge.className = `badge cat-${v.category||'업무'}`;
      badge.textContent= v.category||'업무';
      tdCat.appendChild(badge);

      const tdNote  = document.createElement('td'); tdNote.textContent  = v.note||'';

      const tdAct   = document.createElement('td'); tdAct.className='ea-td-actions';
      const btnE = Object.assign(document.createElement('button'), { className:'ea-btn', type:'button', textContent:'수정' });
      const btnD = Object.assign(document.createElement('button'), { className:'ea-btn', type:'button', textContent:'삭제' });
      btnE.onclick = ()=> openEdit(v);
      btnD.onclick = ()=> del(v.id);
      tdAct.append(btnE, btnD);

      tr.append(tdTitle, tdPeriod, tdLane, tdCat, tdNote, tdAct);
      tbody.appendChild(tr);
    });
  }

  /* -------------------- 수정/삭제 -------------------- */
  let editingId = null;

  function openEdit(v){
    editingId = v.id;
    $('#e-title').value = v.title||'';
    $('#e-category').value = v.category||'업무';
    $('#e-start').value = v.start||'';
    $('#e-end').value = v.end||'';
    $('#e-lane').value = v.lane||LANES[0];
    $('#e-note').value = v.note||'';
    showModal(true);
  }
  async function saveEdit(){
    if(!editingId) return;
    const ref = doc(db,'events', editingId);
    const title = $('#e-title').value.trim();
    const category = $('#e-category').value;
    const start = $('#e-start').value;
    const end = $('#e-end').value || start;
    const lane = $('#e-lane').value;
    const note = $('#e-note').value.trim();

    if(!title || !start || !end || !lane){ toast('필수 항목을 확인하세요.'); return; }

    try{
      await updateDoc(ref, { title, category, start, end, lane, note });
      toast('수정되었습니다.');
      showModal(false);
    }catch(err){
      console.error(err); toast('수정 실패');
    }
  }
  async function del(id){
    if(!confirm('이 일정을 삭제할까요?')) return;
    try{
      await deleteDoc(doc(db,'events',id));
      toast('삭제되었습니다.');
    }catch(err){
      console.error(err); toast('삭제 실패');
    }
  }

  // 모달 열고닫기
  const modal = $('#edit-modal');
  function showModal(on){
    modal.style.display = on ? 'flex' : 'none';
    modal.setAttribute('aria-hidden', on ? 'false':'true');
  }
  modal.addEventListener('click', (e)=>{ if(e.target.id==='edit-modal') showModal(false); });
  document.getElementById('edit-cancel').onclick = ()=> showModal(false);
  document.getElementById('edit-save').onclick   = saveEdit;

  // UX: 종료일 비어있으면 시작일 복사
  document.getElementById('start').addEventListener('change', e=>{
    const s = e.target.value;
    const end = document.getElementById('end');
    if(!end.value) end.value = s;
  });
  document.getElementById('e-start').addEventListener('change', e=>{
    const s = e.target.value;
    const end = document.getElementById('e-end');
    if(!end.value) end.value = s;
  });
</script>
</body>
</html>
