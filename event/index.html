<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Event Admin</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;margin:24px;background:#f6f7f9;color:#0f172a}
  .wrap{max-width:960px;margin:0 auto}
  h1{margin:0 0 16px;font-size:22px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.04)}
  .grid{display:grid;gap:10px}
  label{font-size:12px;color:#334155}
  input,select,textarea{width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
  button,.btn{border:1px solid #e5e7eb;border-radius:10px;background:#fff;padding:8px 12px;cursor:pointer}
  .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
  .row{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
  .row > .grow{grid-column:1/-1}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #e5e7eb;padding:8px;text-align:left;font-size:13px}
  th{background:#f9fafb}
  .toolbar{display:flex;gap:8px;align-items:center;margin:16px 0}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);padding:20px}
  .modal .box{background:#fff;border:1px solid #e5e7eb;border-radius:12px;max-width:560px;width:100%;padding:16px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Event Admin</h1>

  <!-- 신규 등록 -->
  <form id="create-form" class="card" style="padding:12px;margin-bottom:16px">
    <div class="grid">
      <div class="row">
        <label>제목<input name="title" required placeholder="예: Leadership Day"></label>
        <label>시작일<input type="date" name="start" required></label>
        <label>종료일<input type="date" name="end" required></label>
        <label>카테고리
          <select name="category" required>
            <option value="행사">행사</option>
            <option value="업무">업무</option>
            <option value="신청">신청</option>
          </select>
        </label>
        <label>레인(팀)
          <select name="lane" required id="lane-select"></select>
        </label>
        <label>메모(선택)<input name="note" placeholder="비고"></label>
      </div>
      <div><button class="btn primary" type="submit">등록</button></div>
    </div>
  </form>

  <!-- 목록/검색 -->
  <div class="card" style="padding:12px">
    <div class="toolbar">
      <input id="search" placeholder="제목/팀/카테고리 검색">
      <select id="sort">
        <option value="start_asc">시작일 ▲</option>
        <option value="start_desc">시작일 ▼</option>
        <option value="created_desc">최근등록 ▼</option>
      </select>
      <button id="refresh" class="btn">새로고침</button>
    </div>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th style="min-width:160px">제목</th>
            <th style="min-width:110px">기간</th>
            <th style="min-width:80px">팀</th>
            <th style="min-width:70px">카테고리</th>
            <th style="min-width:220px">메모</th>
            <th style="min-width:150px">관리</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- 수정 모달 -->
<div class="modal" id="edit-modal" aria-hidden="true">
  <div class="box">
    <h3 style="margin:0 0 10px">이벤트 수정</h3>
    <form id="edit-form" class="grid">
      <input type="hidden" name="id">
      <div class="row">
        <label>제목<input name="title" required></label>
        <label>시작일<input type="date" name="start" required></label>
        <label>종료일<input type="date" name="end" required></label>
        <label>카테고리
          <select name="category" required>
            <option value="행사">행사</option>
            <option value="업무">업무</option>
            <option value="신청">신청</option>
          </select>
        </label>
        <label>레인(팀)
          <select name="lane" required id="edit-lane-select"></select>
        </label>
        <label>메모(선택)<input name="note"></label>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button type="button" class="btn" id="edit-cancel">취소</button>
        <button type="submit" class="btn primary">저장</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
  const LANES = ["대표실","컴플","전략","재경","P&C","미션","교파","교미","비전","무브","디이","마캠","브컴","크리","특후","IT","SE","SR"];
  const laneSel = document.getElementById('lane-select');
  const editLaneSel = document.getElementById('edit-lane-select');
  laneSel.innerHTML = LANES.map(l=>`<option value="${l}">${l}</option>`).join('');
  editLaneSel.innerHTML = laneSel.innerHTML;

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp,
    getDocs, query, orderBy, updateDoc, doc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBsTMadItNXG9YqmtFYr9bX6lbt0qIh9FQ",
    authDomain: "dcp-page.firebaseapp.com",
    projectId: "dcp-page",
    storageBucket: "dcp-page.firebasestorage.app",
    messagingSenderId: "1056273445903",
    appId: "1:1056273445903:web:9e924f9bd476a860af1f7a",
    measurementId: "G-CZS1G9M1KQ"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const eventsRef = collection(db, 'events');

  // 등록
  const createForm = document.getElementById('create-form');
  createForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(createForm);
    const data = {
      title: fd.get('title').toString().trim(),
      start: fd.get('start').toString(),
      end  : fd.get('end').toString(),
      category: fd.get('category').toString(),
      lane: fd.get('lane').toString(),
      note: (fd.get('note')||'').toString().trim(),
      createdAt: serverTimestamp()
    };
    if(data.end < data.start){ alert('종료일이 시작일보다 빠를 수 없습니다.'); return; }
    await addDoc(eventsRef, data);
    createForm.reset();
    await load();
    alert('등록되었습니다.');
  });

  // 목록 로드/렌더
  const tbody = document.getElementById('tbody');
  const search = document.getElementById('search');
  const sortSel = document.getElementById('sort');
  document.getElementById('refresh').addEventListener('click', load);

  async function load(){
    // 기본은 시작일 오름차순
    const qs = await getDocs(query(eventsRef, orderBy('start')));
    const list = [];
    qs.forEach(d=>{
      const v = d.data();
      list.push({ id:d.id, ...v });
    });
    render(list);
  }

  function render(list){
    // 검색
    const q = (search.value||'').trim();
    const filtered = q ? list.filter(v=>{
      const hay = `${v.title||''} ${v.lane||''} ${v.category||''} ${v.note||''}`.toLowerCase();
      return hay.includes(q.toLowerCase());
    }) : list;

    // 정렬
    const sort = sortSel.value;
    filtered.sort((a,b)=>{
      if(sort==='start_desc') return (b.start||'').localeCompare(a.start||'');
      if(sort==='created_desc') return (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0);
      return (a.start||'').localeCompare(b.start||'');
    });

    // 렌더
    tbody.innerHTML = filtered.map(v=>{
      const period = v.start && v.end ? `${v.start} ~ ${v.end}` : '';
      return `<tr>
        <td>${escapeHtml(v.title||'')}</td>
        <td>${period}</td>
        <td>${escapeHtml(v.lane||'')}</td>
        <td>${escapeHtml(v.category||'')}</td>
        <td>${escapeHtml(v.note||'')}</td>
        <td>
          <button class="btn" data-edit="${v.id}">수정</button>
          <button class="btn" data-del="${v.id}" style="margin-left:6px">삭제</button>
        </td>
      </tr>`;
    }).join('');

    // 바인딩
    tbody.querySelectorAll('[data-edit]').forEach(btn=>{
      btn.addEventListener('click', ()=> openEdit(btn.getAttribute('data-edit'), filtered));
    });
    tbody.querySelectorAll('[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=> del(btn.getAttribute('data-del')));
    });
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // 수정 모달
  const editModal = document.getElementById('edit-modal');
  const editForm  = document.getElementById('edit-form');
  document.getElementById('edit-cancel').addEventListener('click', closeEdit);
  editModal.addEventListener('click', (e)=>{ if(e.target.id==='edit-modal') closeEdit(); });

  function openEdit(id, list){
    const v = list.find(x=>x.id===id);
    if(!v) return;
    editForm.id.value = id;
    editForm.title.value = v.title||'';
    editForm.start.value = v.start||'';
    editForm.end.value   = v.end||'';
    editForm.category.value = v.category||'행사';
    editForm.lane.value = v.lane||'';
    editForm.note.value = v.note||'';
    editModal.style.display='flex';
    editModal.setAttribute('aria-hidden','false');
  }
  function closeEdit(){
    editModal.style.display='none';
    editModal.setAttribute('aria-hidden','true');
  }

  editForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = editForm.id.value;
    const ref = doc(db,'events', id);
    const data = {
      title: editForm.title.value.trim(),
      start: editForm.start.value,
      end  : editForm.end.value,
      category: editForm.category.value,
      lane: editForm.lane.value,
      note: editForm.note.value.trim()
    };
    if(data.end < data.start){ alert('종료일이 시작일보다 빠를 수 없습니다.'); return; }
    await updateDoc(ref, data);
    closeEdit();
    await load();
    alert('수정되었습니다.');
  });

  async function del(id){
    if(!confirm('정말 삭제하시겠습니까?')) return;
    await deleteDoc(doc(db,'events', id));
    await load();
    alert('삭제되었습니다.');
  }

  // 초기
  search.addEventListener('input', ()=> load());
  sortSel.addEventListener('change', ()=> load());
  await load();
</script>
</body>
</html>
