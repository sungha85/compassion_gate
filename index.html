<!DOCTYPE html>
<html lang="ko" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="color-scheme" content="light" />
<title>사내 포털 – 바로가기 + 전사일정</title>
<style>
  :root{
    --bg:#f6f7f9; --folder:#ffffff; --line:rgba(0,0,0,.06); --card:#fff; --grid:#e5e7eb; --text:#0f172a;
    --focus:#2563eb; --muted:#64748b; --shadow:0 12px 24px rgba(0,0,0,.06);
    --lane-h:64px; --lane-gap:1px; --left-col:160px; --header-h:34px; --cell-pad:8px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:24px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif; background:var(--bg); color:var(--text)}
  img{max-width:100%; display:block}
  a{color:inherit; text-decoration:none}
  a:focus-visible,button:focus-visible{outline:3px solid var(--focus); outline-offset:3px; border-radius:8px}
  .visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}

  h1{margin:0 0 20px; font-size:18px}
  h2{margin:28px 0 12px; font-size:16px}
  .container{max-width:1200px; margin:0 auto}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:24px}

  /* 폴더 카드 (바로가기) */
  .folder{background:var(--folder);border-radius:28px;padding:18px 16px;border:1px solid var(--line);
          box-shadow:var(--shadow), inset 0 1px 0 rgba(255,255,255,.7); transition:transform .15s, box-shadow .15s}
  .folder:hover{ transform:translateY(-2px); box-shadow:0 16px 30px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.7) }
  .apps{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
  .app{display:flex; align-items:center; justify-content:center; flex-direction:column; color:var(--text); gap:6px; min-height:92px}
  .badge{width:58px;height:58px;border-radius:16px;display:flex;align-items:center;justify-content:center;box-shadow:inset 0 1px 0 rgba(255,255,255,.25), 0 6px 14px rgba(0,0,0,.08);transition:transform .12s, box-shadow .12s; font-weight:700; font-size:12px; color:#fff}
  .app:hover .badge{ transform:translateY(-1px); box-shadow:inset 0 1px 0 rgba(255,255,255,.25), 0 10px 18px rgba(0,0,0,.12) }
  .label{font-size:10px;color:#334155;text-align:center;max-width:84px;line-height:1.2}
  .c-red{background:linear-gradient(135deg,#ff6a7a,#ff3d3d)}
  .c-purple{background:linear-gradient(135deg,#a77bff,#7a4cff)}
  .c-sky{background:linear-gradient(135deg,#79b6ff,#4a8dff)}
  .c-orange{background:linear-gradient(135deg,#ffa552,#ff7a1a)}
  .c-green{background:linear-gradient(135deg,#55d6a9,#26b87a)}
  .c-blue{background:linear-gradient(135deg,#6e8cff,#3b5bff)}
  .c-teal{background:linear-gradient(135deg,#64e0e3,#28c3d6)}
  .c-gray{background:linear-gradient(135deg,#c9ced6,#9aa3ad)}
  .folder-label{display:flex;align-items:center;justify-content:center;gap:6px;margin-top:8px;font-size:14px}
  .folder-label .emoji{display:none !important;} /* 이모지 제거 */

  /* 버튼/컨트롤 공통 */
  .btn{border:1px solid var(--grid);background:#fff;border-radius:10px;padding:8px 12px;font-size:13px;cursor:pointer}
  .btn.ghost{background:#fafafa}
  .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
  .btn[aria-pressed="true"]{box-shadow:inset 0 0 0 2px #2563eb33}

  /* ==== 제목 라인만 하이라이트 ==== */
  .title-strip{
    display:flex; align-items:center; justify-content:space-between;
    padding:20px 18px; margin:0 0 14px; border-radius:14px; color:#fff;
    box-shadow:0 8px 20px rgba(17,38,94,.18);
    background:linear-gradient(135deg,#2a5eec,#6a8ef2);
  }
  .title-strip .btn.ghost{background:rgba(255,255,255,.16); color:#fff; border-color:transparent}
  .title-strip .btn.ghost:hover{background:rgba(255,255,255,.24)}

  /* 캘린더 상단 (Hero) */
  .sp-hero{margin:28px 0 8px}
  .sp-breadcrumb{font-size:12px;color:#6b7280;display:flex;gap:8px;align-items:center}
  .sp-breadcrumb .sep{opacity:.5}
  .sp-titlebar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:6px}
  .sp-titlebar h2{margin:0;font-size:22px}
  .sp-sub{margin:6px 0 0;color:#64748b;font-size:13px}

  /* 일정 컨트롤 바(연/월) */
  .cal-controls{display:flex;gap:8px;align-items:center;margin:10px 0 6px;flex-wrap:wrap}
  .cal-controls .seg{display:inline-flex;border:1px solid var(--grid);border-radius:10px;overflow:hidden}
  .cal-controls .seg button{padding:6px 10px;border:0;background:#fff;font-size:12px;cursor:pointer}
  .cal-controls .seg button[aria-pressed="true"]{background:#eef2ff}
  .cal-controls select{border:1px solid var(--grid);border-radius:10px;padding:6px 10px;background:#fff}

  /* 카드 */
  .card{background:var(--card);border:1px solid var(--grid);border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.04)}

  /* 연간 매트릭스/단월 매트릭스 */
  .year-grid{position:relative;overflow:hidden}
  .header,.row{display:grid}
  .header div,.row div{padding:var(--cell-pad);border-bottom:1px solid var(--grid)}
  .header{background:#f7f8fa;font-size:12px;font-weight:600;position:sticky;top:0;z-index:2}
  .lane-name{padding:10px 12px;border-right:1px solid var(--grid);display:flex;align-items:center;font-size:12px;font-weight:600;background:#f9fafb;color:#111827}
  .cell{height:var(--lane-h);border-left:1px solid var(--grid)}
  .row .cell:first-child{border-left:none}
  .grid-lines{position:absolute;pointer-events:none}
  .grid-lines div{border-left:1px dashed #e6e6e6}
  .bar-layer{position:absolute}
  .event{position:absolute;height:26px;border-radius:8px;padding:4px 8px;font-size:12px;line-height:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.05);font-weight:600}
  .today-line{position:absolute;top:var(--header-h);bottom:0;width:2px;background:#2563eb33;pointer-events:none}

  /* ── 레인 색상 확장 ───────────────────────── */
  .t-대표실{background:#e0f2fe}
  .t-컴플{background:#e8f7ff}
  .t-전략{background:#d1fae5}
  .t-재경{background:#fef9c3}
  .t-P\&C{background:#fee2e2}  /* P&C 이스케이프 */
  .t-미션{background:#f5e8ff}
  .t-교파{background:#e7fff2}
  .t-교미{background:#fff0e5}
  .t-비전{background:#ffe7fb}
  .t-무브{background:#e0e7ff}
  .t-디이{background:#f0f7e9}
  .t-마캠{background:#e9f6ff}
  .t-브컴{background:#fce9ff}
  .t-크리{background:#fff3e9}
  .t-특후{background:#e9fffb}
  .t-IT{background:#e5e7eb}
  .t-SE{background:#f2f2ff}
  .t-SR{background:#f9f2ff}

  /* 접근성/인쇄 */
  @media (prefers-reduced-motion: reduce){ .folder,.badge{transition:none} }
  @media print{
    body{margin:0}
    .grid,.imgbox,.hint,h1,.controls,.sp-hero,.cal-controls{display:none}
    .year-grid{border:0}
  }
</style>
</head>
<body>
<div class="container" role="main">

  <!-- 제목 한 줄만 하이라이트 -->
  <h1 class="title-strip">
    <span>바로가기</span>
    <button id="app-links-btn" class="btn ghost" type="button">앱 링크</button>
  </h1>

  <!-- ▶▶▶ (여기에 기존 “바로가기” 섹션 그대로 유지) ◀◀◀ -->
  <!-- 사용자가 올려주신 바로가기/카테고리 섹션을 그대로 두세요. -->

  <!-- ====================== 전사일정&행사 ====================== -->
  <section class="sp-hero" aria-labelledby="ecal-title">
    <div class="sp-titlebar">
      <h2 id="ecal-title">Enterprise Calendar</h2>
      <div class="sp-actions" role="toolbar" aria-label="Calendar actions">
        <button type="button" class="btn ghost" id="btn-compact" aria-pressed="false" title="밀집 보기">Compact</button>
        <button type="button" class="btn" id="btn-export" title="CSV로 내보내기">Export</button>
        <!-- 새 창으로 열기 -->
        <a class="btn primary" id="btn-add" href="https://sungha85.github.io/compassion_gate/event/" target="_blank" rel="noopener" title="일정 추가">Add Event</a>
      </div>
    </div>
    <p class="sp-sub">원하는 연·월을 선택해 해당 달의 일정만 확인하세요.</p>
  </section>

  <!-- (A) 연/월 컨트롤 -->
  <div class="cal-controls">
    <button class="btn" id="prev-month" title="이전 달">◀</button>
    <select id="year-select" aria-label="연도 선택"></select>
    <div class="seg" id="month-buttons" role="tablist" aria-label="월 선택"></div>
    <button class="btn" id="next-month" title="다음 달">▶</button>
    <label style="margin-left:auto;display:flex;align-items:center;gap:6px;">
      <input type="checkbox" id="toggle-annual"> 연간 보기
    </label>
  </div>

  <!-- (B) 캘린더 스냅샷(선택) -->
  <div class="card imgbox" aria-label="전사 일정 이미지 미리보기">
    <img id="calendar-thumb" src="enterprise-calendar.png" alt="Enterprise Calendar" loading="lazy" onclick="openImage()" onload="calendarImageReady()" onerror="calendarImageMissing()" />
  </div>

  <!-- (C) 매트릭스 -->
  <div class="card year-grid" style="margin-top:8px" id="year-grid" aria-labelledby="year-title">
    <div id="year-title" class="visually-hidden" aria-hidden="true">일정 매트릭스</div>

    <!-- 동적 생성: header, rows, grid-lines, bar-layer -->
    <div class="header" id="grid-header"></div>
    <div id="lane-rows"></div>
    <div class="grid-lines" id="grid-lines" aria-hidden="true"></div>
    <div class="today-line" id="today-line" aria-hidden="true"></div>
    <div class="bar-layer" id="bar-layer"></div>
  </div>

  <p class="hint">※ Firestore에 저장된 데이터를 실시간으로 읽어옵니다.</p>
</div>

<!-- 공용 모달(캘린더 이미지 보기 & 이벤트 상세) -->
<div id="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="m-title" aria-describedby="m-when m-dept m-note" style="display:none;align-items:center;justify-content:center;position:fixed;inset:0;background:rgba(0,0,0,.45);padding:20px">
  <div class="box" style="background:#fff;border-radius:14px;padding:18px;max-width:560px;width:100%;border:1px solid var(--grid);box-shadow:0 10px 30px rgba(0,0,0,.15)">
    <h3 id="m-title" style="margin:0 0 8px;font-size:16px"></h3>
    <p id="m-when" style="margin:6px 0 0;font-size:13px;color:#334155;white-space:pre-line"></p>
    <p id="m-dept" style="margin:6px 0 0;font-size:13px;color:#334155;white-space:pre-line"></p>
    <p id="m-note" style="margin:6px 0 0;font-size:13px;color:#334155;white-space:pre-line"></p>
    <div class="modal-actions" style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px"><button class="close btn" id="closeBtn">닫기 (Esc)</button></div>
  </div>
</div>

<script type="module">
  /* ===================== Firestore 연동 + 월/연도 보기 ===================== */
  const $ = (s)=>document.querySelector(s);
  const KST = new Intl.DateTimeFormat('ko-KR',{ timeZone:'Asia/Seoul', dateStyle:'medium' });
  const fmtRange = (s,e)=> `${KST.format(s)} ~ ${KST.format(e)}`;
  const parseDate = (s)=>{ const [y,m,d] = s.split('-').map(Number); return new Date(y, m-1, d); };
  const monthNames = ["1월","2월","3월","4월","5월","6월","7월","8월","9월","10월","11월","12월"];

  const LANES = ["대표실","컴플","전략","재경","P&C","미션","교파","교미","비전","무브","디이","마캠","브컴","크리","특후","IT","SE","SR"];
  const CATEGORIES = ["행사","업무","신청"];

  const headerEl = $("#grid-header");
  const rowsEl = $("#lane-rows");
  const linesEl = $("#grid-lines");
  const layerEl = $("#bar-layer");
  const todayEl = $("#today-line");

  // 뷰 상태
  const today = new Date();
  let viewYear  = today.getFullYear();
  let viewMonth = today.getMonth()+1; // 1..12
  let annual = false;

  // 연/월 컨트롤 빌드
  (function initYMControls(){
    // 연도: 과거 2년 ~ 내년
    const ysel = $("#year-select");
    const startY = today.getFullYear()-2, endY = today.getFullYear()+1;
    for(let y=startY;y<=endY;y++){
      const opt = document.createElement('option');
      opt.value = y; opt.textContent = y+'년';
      if(y===viewYear) opt.selected = true;
      ysel.appendChild(opt);
    }
    ysel.addEventListener('change', ()=>{ viewYear = Number(ysel.value); refresh(); });

    // 월 버튼
    const mwrap = $("#month-buttons");
    monthNames.forEach((name,idx)=>{
      const m = idx+1;
      const b = document.createElement('button');
      b.textContent = name;
      b.setAttribute('role','tab');
      b.setAttribute('aria-pressed', String(viewMonth===m));
      b.addEventListener('click', ()=>{
        viewMonth = m;
        // aria-pressed 업데이트
        [...mwrap.children].forEach(x=>x.setAttribute('aria-pressed','false'));
        b.setAttribute('aria-pressed','true');
        refresh();
      });
      mwrap.appendChild(b);
    });

    // 이전/다음
    $("#prev-month").addEventListener('click', ()=>{
      if(viewMonth===1){ viewMonth=12; viewYear--; } else viewMonth--;
      ysel.value = String(viewYear);
      mwrap.children[viewMonth-1].click();
    });
    $("#next-month").addEventListener('click', ()=>{
      if(viewMonth===12){ viewMonth=1; viewYear++; } else viewMonth++;
      ysel.value = String(viewYear);
      mwrap.children[viewMonth-1].click();
    });

    // 연간 보기
    const tgl = $("#toggle-annual");
    tgl.checked = annual;
    tgl.addEventListener('change', ()=>{ annual = tgl.checked; buildGrid(); refresh(); });
  })();

  // 그리드 구성(연간/단월)
  function buildGrid(){
    // 헤더/바닥 초기화
    headerEl.innerHTML = '';
    rowsEl.innerHTML = '';
    linesEl.innerHTML = '';
    layerEl.innerHTML = '';

    if(annual){
      headerEl.style.gridTemplateColumns = `var(--left-col) repeat(12,1fr)`;
      rowsEl.style.gridTemplateColumns = `var(--left-col) repeat(12,1fr)`;
      linesEl.style.inset = `var(--header-h) 0 0 var(--left-col)`;
      linesEl.style.display = 'grid';
      linesEl.style.gridTemplateColumns = `repeat(12,1fr)`;

      // 헤더
      const empty = document.createElement('div');
      empty.style.borderRight = '1px solid var(--grid)';
      headerEl.appendChild(empty);
      for(let i=0;i<12;i++){
        const m = document.createElement('div');
        m.textContent = monthNames[i];
        headerEl.appendChild(m);
        const gl = document.createElement('div');
        linesEl.appendChild(gl);
      }
    }else{
      headerEl.style.gridTemplateColumns = `var(--left-col) 1fr`;
      rowsEl.style.gridTemplateColumns = `var(--left-col) 1fr`;
      linesEl.style.inset = `var(--header-h) 0 0 var(--left-col)`;
      linesEl.style.display = 'grid';
      linesEl.style.gridTemplateColumns = `1fr`;

      // 헤더
      const empty = document.createElement('div');
      empty.style.borderRight = '1px solid var(--grid)';
      headerEl.appendChild(empty);
      const m = document.createElement('div');
      m.textContent = `${viewYear}년 ${monthNames[viewMonth-1]}`;
      headerEl.appendChild(m);
      const gl = document.createElement('div');
      linesEl.appendChild(gl);
    }

    // 레인 행
    LANES.forEach(name=>{
      const row = document.createElement('div');
      row.className = 'row';
      row.style.gridTemplateColumns = annual ? `var(--left-col) repeat(12,1fr)` : `var(--left-col) 1fr`;
      const lane = document.createElement('div');
      lane.className = 'lane-name';
      lane.textContent = name;
      row.appendChild(lane);
      const colCount = annual ? 12 : 1;
      for(let i=0;i<colCount;i++){
        const cell = document.createElement('div');
        cell.className = 'cell';
        row.appendChild(cell);
      }
      rowsEl.appendChild(row);
    });

    // today line
    if(annual){
      const now = new Date();
      if(now.getFullYear()===viewYear){
        const month = now.getMonth();
        const day = now.getDate();
        const dim = new Date(now.getFullYear(), month+1, 0).getDate();
        const frac = month + (day-1)/dim; // 0~11.x
        const leftPct = (frac/12)*100;
        todayEl.style.left = `calc(${leftPct}% + var(--left-col))`;
        todayEl.style.display = 'block';
      }else{
        todayEl.style.display = 'none';
      }
      todayEl.style.top = 'var(--header-h)';
      todayEl.style.bottom = '0';
    }else{
      todayEl.style.display = 'none'; // 단월 모드에서는 숨김
      // 위치 기준 박스(레이어)도 단월에 맞춰 inset
    }

    // 레이어 위치 조정
    const headerH = getComputedStyle(document.documentElement).getPropertyValue('--header-h');
    layerEl.style.inset = `var(--header-h) 0 0 var(--left-col)`;
  }

  function laneY(laneName){
    const idx = LANES.indexOf(laneName);
    const header = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--header-h'));
    const laneH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--lane-h'));
    const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--lane-gap'));
    return header + idx * (laneH + gap);
  }

  // Firestore 구독
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBsTMadItNXG9YqmtFYr9bX6lbt0qIh9FQ",
    authDomain: "dcp-page.firebaseapp.com",
    projectId: "dcp-page",
    storageBucket: "dcp-page.firebasestorage.app",
    messagingSenderId: "1056273445903",
    appId: "1:1056273445903:web:9e924f9bd476a860af1f7a",
    measurementId: "G-CZS1G9M1KQ"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  let EVENTS = [];

  const eventsRef = collection(db, 'events');
  const q = query(eventsRef, orderBy('start')); // 시작일 기준
  onSnapshot(q, (snapshot)=>{
    const next = [];
    snapshot.forEach(doc=>{
      const d = doc.data();
      next.push({
        id: doc.id,
        title: d.title || '(제목 없음)',
        start: d.start || '',
        end  : d.end   || '',
        category: d.category || '',
        lane: d.lane || '',
        note: d.note || ''
      });
    });
    // 보정 정렬
    next.sort((a,b)=> (a.start||'').localeCompare(b.start||''));
    EVENTS = next;
    refresh();
  }, (err)=> console.error('[Firestore] onSnapshot error:', err));

  // 렌더
  function intersectsMonth(ev, y, m){
    if(!ev.start || !ev.end) return false;
    const s = parseDate(ev.start), e = parseDate(ev.end);
    const first = new Date(y, m-1, 1);
    const last  = new Date(y, m, 0);
    return s <= last && e >= first; // 기간이 그 달과 겹치면 표시
  }

  function renderBars(){
    layerEl.innerHTML = '';
    const list = annual ? EVENTS : EVENTS.filter(ev => intersectsMonth(ev, viewYear, viewMonth));

    list.forEach(ev=>{
      if(!ev.lane || LANES.indexOf(ev.lane)<0) return;
      // 위치/폭
      let leftPct = 0, widthPct = 100;
      if(annual){
        const s = parseDate(ev.start||`${viewYear}-01-01`);
        const startIdx = Math.min(11, Math.max(0, s.getMonth())); // 0..11
        leftPct = (startIdx/12)*100;
        // span(월)
        const e = parseDate(ev.end||`${viewYear}-12-31`);
        const months = (e.getFullYear()-s.getFullYear())*12 + (e.getMonth()-s.getMonth()) + 1;
        widthPct = Math.max(1, Math.min(12, months)) / 12 * 100;
      }else{
        // 단월: 항상 1칸(100%)
        leftPct = 0; widthPct = 100;
      }

      const bar = document.createElement('div');
      bar.className = `event t-${ev.lane}`;
      bar.style.left = `calc(${leftPct}% + 6px)`;
      bar.style.top  = `${laneY(ev.lane) + 18}px`;
      bar.style.width= `calc(${widthPct}% - 12px)`;
      bar.tabIndex = 0;
      bar.setAttribute('role','button');
      bar.setAttribute('aria-label', `${ev.lane} · ${ev.title} · ${ev.start} ~ ${ev.end} · ${ev.category}`);
      bar.textContent = ev.title || '(제목 없음)';
      bar.addEventListener('click', ()=>openModal(ev));
      bar.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); openModal(ev); } });
      layerEl.appendChild(bar);
    });
  }

  function openModal(ev){
    $("#m-title").textContent = ev.title || '(제목 없음)';
    const s = ev.start?parseDate(ev.start):null, e = ev.end?parseDate(ev.end):null;
    $("#m-when").textContent = (s && e) ? `일정: ${fmtRange(s,e)}` : '';
    $("#m-dept").textContent = `팀: ${ev.lane||''} · 카테고리: ${ev.category||''}`;
    $("#m-note").textContent = ev.note ? `메모: ${ev.note}` : '';
    const modal = $("#modal");
    modal.style.display='flex';
    modal.setAttribute('aria-hidden','false');
    document.body.style.overflow='hidden';
    $("#closeBtn").focus();
  }
  function closeModal(){
    const modal = $("#modal");
    modal.style.display='none';
    modal.setAttribute('aria-hidden','true');
    document.body.style.overflow='';
  }
  $("#modal")?.addEventListener('click', (e)=>{ if(e.target.id==='modal') closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
  $("#closeBtn")?.addEventListener('click', closeModal);

  // Compact 토글
  $("#btn-compact")?.addEventListener('click', ()=>{
    const on = document.body.classList.toggle('compact');
    $("#btn-compact").setAttribute('aria-pressed', String(on));
    refresh();
  });

  // Export CSV
  $("#btn-export")?.addEventListener('click', ()=>{
    const headers=["title","start","end","lane","category","note"];
    const source = annual ? EVENTS : EVENTS.filter(ev => intersectsMonth(ev, viewYear, viewMonth));
    const rows=[headers.join(",")].concat(
      source.map(ev=>headers.map(h=>{
        const val=(ev[h]??"").toString().replace(/"/g,'""');
        return /[",\n]/.test(val)?`"${val}"`:val;
      }).join(","))
    );
    const csv = rows.join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `calendar_${annual?'year':'month'}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  // 이미지 보기 썸네일
  let imageAvailable=false;
  window.calendarImageReady=()=>{ imageAvailable=true; };
  window.calendarImageMissing=()=>{ imageAvailable=false; document.querySelector('.imgbox')?.remove(); };
  window.openImage=()=>{
    if(!imageAvailable) return;
    const modal = $("#modal");
    $("#m-title").textContent='전사일정&행사 (이미지)';
    $("#m-when").innerHTML='<img src="enterprise-calendar.png" style="width:100%;border:1px solid #e5e7eb;border-radius:8px" alt="calendar" />';
    $("#m-dept").textContent='';
    $("#m-note").textContent='';
    modal.style.display='flex';
    modal.setAttribute('aria-hidden','false');
    document.body.style.overflow='hidden';
    $("#closeBtn").focus();
  };

  function refresh(){ renderBars(); }
  window.addEventListener('resize', refresh);

  // 최초 그리드 구성 + 첫 렌더
  buildGrid();
  refresh();
</script>
</body>
</html>
